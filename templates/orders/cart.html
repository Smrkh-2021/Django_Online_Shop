{% extends 'base/base.html' %}
{% block slider %}{% endblock %}
{% block banner %}{% endblock %}
{% block content %}
    <!--shopping cart area start -->
    <div class="shopping_cart_area mt-32">
        <div class="container">
            <form action="#">
                <div class="row">
                    <div class="col-12">
                        <div class="table_desc">
                            <div class="cart_page table-responsive">
                                <table>
                                    <thead>
                                    <tr>
                                        <th class="product_remove">Delete</th>
                                        <th class="product_thumb">Image</th>
                                        <th class="product_name">Product</th>
                                        <th class="product-price">Price</th>
                                        <th class="product_quantity">Quantity</th>
                                        <th class="product_total">Total</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for orderitem in items %}
                                        <tr>
                                            <td class="product_remove" orderitem_id="{{ orderitem.id }}"><a
                                                    href=""><i class="fa fa-trash-o"></i></a></td>
                                            <td class="product_thumb"><a href="#"><img
                                                    src="{{ orderitem.product.image_main.url }}" alt=""></a></td>
                                            <td class="product_name"><a href="#">{{ orderitem.product.name }}</a></td>
                                            <td class="product_price" price="{{ orderitem.product.price }}">
                                                ${{ orderitem.product.price }}</td>
                                            <td class="product_quantity"><label>Quantity</label> <input min="1"
                                                                                                        max="{{ orderitem.product.count }}"
                                                                                                        value="1"
                                                                                                        type="number">
                                            </td>
                                            <td class="product_total">${{ orderitem.product.price }}</td>
                                        </tr>
                                        </tbody>
                                        <div class="order_id" style="display: none"
                                             order_id="{{ orderitem.order.id }}"></div>
                                    {% endfor %}
                                </table>
                            </div>
                            <div class="cart_submit">
                                <button type="submit">update cart</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!--coupon code area start-->
                <div class="coupon_area">
                    <div class="row">
                        <div class="col-lg-6 col-md-6">
                            <div class="coupon_code left">
                                <h3>Coupon</h3>
                                <div class="coupon_inner">
                                    <p>Enter your coupon code if you have one.</p>
                                    <input placeholder="Coupon code" type="text" id="coupon_id">
                                    <button type="submit" id="coupon_btn">Apply coupon</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="coupon_code right">
                                <h3>Cart Totals</h3>
                                <div class="coupon_inner">
                                    <div class="cart_subtotal">
                                        <p>Subtotal</p>
                                        <p class="cart_amount">£215.00</p>
                                    </div>
                                    <div class="cart_subtotal ">
                                        <p>Shipping</p>
                                        <p class="cart_amount"><span>Flat Rate:</span> £255.00</p>
                                    </div>
                                    <a href="#">Calculate shipping</a>

                                    <div class="cart_subtotal">
                                        <p>Total</p>
                                        <p class="cart_amount">£215.00</p>
                                    </div>
                                    <div class="checkout_btn">
                                        <a href="#">Proceed to Checkout</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--coupon code area end-->
            </form>
        </div>
    </div>
    <!--shopping cart area end -->
    <script>

        $('.product_quantity input').change(function () {
            let quantity = $(this).val()
            let price = $(this).parent().parent().children('td.product_price').attr('price')
            let product_total_price = quantity * price
            $(this).parent().parent().children('td.product_total').html(`${product_total_price}$`)
        })


        $('#coupon_btn').on('click', function () {
            let coupon = $('#coupon_id').val()
            let order_id = $('.order_id').attr('order_id')
            console.log(order_id)
            JsonData = {'offcode': coupon,}
            $.ajax({
                type: 'PATCH',
                url: '{% url 'order-detail' 0 %}'.replace('0', order_id),
                data: JsonData,
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function (response) {
                    console.log('okk')
                },
                error: function (error) {
                    console.log(error)
                }
            })
        })


        $('.product_remove').on('click', function () {
            console.log('delete')
            let parent = $(this).parent()
            let orderitem_id = $(this).attr('orderitem_id')
            console.log('orderitem_id', orderitem_id)
            $.ajax({
                type: 'DELETE',
                url: '{% url 'orders:orderitem_delete' 0 %}'.replace('0', orderitem_id),
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function () {
                    console.log('miad')
                    parent.remove()
                },
                error: function (error) {
                    console.log(error)
                }
            })
        })


        {#    /* Set rates + misc */#}
        {#var taxRate = 0.05;#}
        {#var shippingRate = 15.0;#}
        {#var fadeTime = 300;#}
        {##}
        {#/* Assign actions */#}
        {#$(".product_quantity input").change(function () {#}
        {#  updateQuantity(this);#}

        {##}
        {#$(".product-removal button").click(function () {#}
        {#  removeItem(this);#}

        {##}
        {#/* Recalculate cart */#}
        {#function recalculateCart() {#}
        {#  var subtotal = 0;#}
        {##}
        {#  /* Sum up row totals */#}
        {#  $(".product").each(function () {#}
        {#    subtotal += parseFloat($(this).children(".product-line-price").text());#}
        {#  });#}
        {##}
        {#  /* Calculate totals */#}
        {#  var tax = subtotal * taxRate;#}
        {#  var shipping = subtotal > 0 ? shippingRate : 0;#}
        {#  var total = subtotal + tax + shipping;#}
        {##}
        {#  /* Update totals display */#}
        {#  $(".totals-value").fadeOut(fadeTime, function () {#}
        {#    $("#cart-subtotal").html(subtotal.toFixed(2));#}
        {#    $("#cart-tax").html(tax.toFixed(2));#}
        {#    $("#cart-shipping").html(shipping.toFixed(2));#}
        {#    $("#cart-total").html(total.toFixed(2));#}
        {#    if (total == 0) {#}
        {#      $(".checkout").fadeOut(fadeTime);#}
        {#    } else {#}
        {#      $(".checkout").fadeIn(fadeTime);#}
        {#    }#}
        {#    $(".totals-value").fadeIn(fadeTime);#}
        {#  });#}

        {##}
        {#/* Update quantity */#}
        {#function updateQuantity(quantityInput) {#}
        {#  /* Calculate line price */#}
        {#  var productRow = $(quantityInput).parent().parent();#}
        {#  var price = parseFloat(productRow.children(".product-price").text());#}
        {#  var quantity = $(quantityInput).val();#}
        {#  var linePrice = price * quantity;#}
        {##}
        {#  /* Update line price display and recalc cart totals */#}
        {#  productRow.children(".product-line-price").each(function () {#}
        {#    $(this).fadeOut(fadeTime, function () {#}
        {#      $(this).text(linePrice.toFixed(2));#}
        {#      recalculateCart();#}
        {#      $(this).fadeIn(fadeTime);#}
        {#    });#}
        {#  });#}

        {##}
        {#/* Remove item from cart */#}
        {#function removeItem(removeButton) {#}
        {#  /* Remove row from DOM and recalc cart total */#}
        {#  var productRow = $(removeButton).parent().parent();#}
        {#  productRow.slideUp(fadeTime, function () {#}
        {#    productRow.remove();#}
        {#    recalculateCart();#}
        {#  });#}

    </script>
{% endblock %}